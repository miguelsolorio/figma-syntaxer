<div id="theme-selector">
  <select id="theme-dropdown">
    <option value="light-plus" selected>Light Plus</option>
    <option value="dark-plus">Dark Plus</option>
    <option value="github-dark">GitHub Dark</option>
    <option value="github-light">GitHub Light</option>
    <option value="min-dark">Min Dark</option>
    <option value="min-light">Min Light</option>
    <option value="monokai">Monokai</option>
    <option value="nord">Nord</option>
    <option value="one-dark-pro">One Dark Pro</option>
    <option value="poimandres">Poimandres</option>
    <option value="rose-pine">Rose Pine</option>
    <option value="slack-dark">Slack Dark</option>
    <option value="slack-ochin">Slack Ochin</option>
    <option value="solarized-dark">Solarized Dark</option>
    <option value="solarized-light">Solarized Light</option>
    <option value="vitesse-dark">Vitesse Dark</option>
    <option value="vitesse-light">Vitesse Light</option>
  </select>
  <select id="language-dropdown">
    <option value="python" selected>Python</option>
    <option value="javascript">JavaScript</option>
    <option value="typescript">TypeScript</option>
    <option value="html">HTML</option>
    <option value="css">CSS</option>
    <option value="json">JSON</option>
    <option value="markdown">Markdown</option>
    <option value="java">Java</option>
    <option value="c">C</option>
    <option value="cpp">C++</option>
    <option value="csharp">C#</option>
    <option value="go">Go</option>
    <option value="rust">Rust</option>
    <option value="swift">Swift</option>
    <option value="php">PHP</option>
    <option value="ruby">Ruby</option>
    <option value="sql">SQL</option>
    <option value="shell">Shell</option>
    <option value="yaml">YAML</option>
    <option value="xml">XML</option>
  </select>
  <button id="apply-button">Apply</button>
</div>
<div id="code-container"></div>

<link id="shiki-theme" rel="stylesheet" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: sans-serif;
    overflow: hidden;
  }
  #theme-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #f0f0f0;
    border-bottom: 1px solid #ccc;
  }
  #code-container {
    height: calc(100% - 50px); /* Subtract the height of #theme-selector */
    overflow-y: auto;
    white-space: pre-wrap;
  }
  #code-container pre {
    margin: 0;
    padding: 20px;
    min-height: 100%;
  }
  #theme-dropdown {
    width: 70%;
    padding: 5px;
  }
  #apply-button {
    width: 25%;
    padding: 5px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }
  #apply-button:hover {
    background-color: #45a049;
  }
</style>

<script>
let currentLanguage = 'python';

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

async function loadShiki() {
  await loadScript('https://cdn.jsdelivr.net/npm/shiki@0.14.1/dist/index.unpkg.iife.js');
  return window.shiki;
}

async function highlightCode(code, language = currentLanguage) {
  const shiki = await loadShiki();
  const highlighter = await shiki.getHighlighter({
    theme: document.getElementById('theme-dropdown').value,
    langs: [language]
  });
  
  const escapedCode = escapeHtml(code);
  const highlightedCode = highlighter.codeToHtml(escapedCode, { lang: language });
  
  const codeContainer = document.getElementById('code-container');
  codeContainer.innerHTML = highlightedCode;
  
  // Remove the resizing code
}

async function changeTheme(theme) {
  const shiki = await loadShiki();
  const highlighter = await shiki.getHighlighter({
    theme: theme,
    langs: [currentLanguage]
  });
  
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const code = codeElement.textContent;
    const highlightedCode = highlighter.codeToHtml(code, { lang: currentLanguage });
    document.getElementById('code-container').innerHTML = highlightedCode;
    
    // Send message to plugin code to save the theme
    parent.postMessage({ pluginMessage: { type: 'themeChanged', theme } }, '*');
    
    // Remove the resizing code
  }
}

function changeLanguage(language) {
  currentLanguage = language;
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const code = codeElement.textContent;
    highlightCode(code, language);
  }
}

function applyColors() {
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const colorData = [];
    const backgroundColor = window.getComputedStyle(codeElement).backgroundColor;
    
    // Recursively process all child nodes
    function processNode(node) {
      if (node.nodeType === Node.TEXT_NODE) {
        const parentStyle = window.getComputedStyle(node.parentElement);
        colorData.push({
          text: node.textContent,
          color: parentStyle.color
        });
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        for (let child of node.childNodes) {
          processNode(child);
        }
      }
    }
    
    processNode(codeElement);
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'applyDetailedColors', 
        colorData,
        backgroundColor
      } 
    }, '*');
  }
}

document.getElementById('theme-dropdown').addEventListener('change', (event) => {
  changeTheme(event.target.value);
});

document.getElementById('language-dropdown').addEventListener('change', (event) => {
  changeLanguage(event.target.value);
});

document.getElementById('apply-button').addEventListener('click', applyColors);

onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'code') {
    highlightCode(msg.content, currentLanguage);
  } else if (msg.type === 'no-selection') {
    document.getElementById('code-container').innerHTML = '<p>Please select a single text layer</p>';
  } else if (msg.type === 'setTheme') {
    document.getElementById('theme-dropdown').value = msg.theme;
    changeTheme(msg.theme);
  }
}

async function initPlugin() {
  try {
    await loadShiki();
    
    // Set the default theme to Light Plus
    await changeTheme('light-plus');
    
    // Update the dropdowns to reflect the default values
    document.getElementById('theme-dropdown').value = 'light-plus';
    document.getElementById('language-dropdown').value = 'python';
    
    parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
  } catch (error) {
    console.error('Failed to load Shiki:', error);
  }
}

initPlugin();
</script>
