<div id="code-container"></div>

<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
  }
  #code-container {
    white-space: pre-wrap;
  }
  #code-container pre {
    margin: 0;
    padding: 20px;
  }
</style>

<script>
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function highlightCode(code) {
  const escapedCode = escapeHtml(code);
  const codeContainer = document.getElementById('code-container');
  codeContainer.innerHTML = `<pre><code class="language-javascript">${escapedCode}</code></pre>`;
  if (typeof Prism !== 'undefined') {
    Prism.highlightAll();
    // After highlighting, calculate dimensions and resize
    const width = codeContainer.scrollWidth; // Add some padding
    const height = codeContainer.scrollHeight; // Add padding for header
    parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
  } else {
    console.error('Prism is not defined');
  }
}

onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'code') {
    highlightCode(msg.content);
  } else if (msg.type === 'no-selection') {
    document.getElementById('code-container').innerHTML = '<p>Please select a single text layer</p>';
  }
}

async function initPlugin() {
  try {
    await loadScript('https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js');
    await loadScript('https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js');
    parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
  } catch (error) {
    console.error('Failed to load Prism:', error);
  }
}

initPlugin();
</script>
