<div class="flex flex-col h-screen bg-white">
  <div class="flex justify-between items-center p-4 bg-gray-100 shadow-md">
    <select id="theme-dropdown" class="w-1/3 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="light-plus" selected>Light Plus</option>
      <option value="dark-plus">Dark Plus</option>
      <option value="github-dark">GitHub Dark</option>
      <option value="github-light">GitHub Light</option>
      <option value="min-dark">Min Dark</option>
      <option value="min-light">Min Light</option>
      <option value="monokai">Monokai</option>
      <option value="nord">Nord</option>
      <option value="one-dark-pro">One Dark Pro</option>
      <option value="poimandres">Poimandres</option>
      <option value="rose-pine">Rose Pine</option>
      <option value="slack-dark">Slack Dark</option>
      <option value="slack-ochin">Slack Ochin</option>
      <option value="solarized-dark">Solarized Dark</option>
      <option value="solarized-light">Solarized Light</option>
      <option value="vitesse-dark">Vitesse Dark</option>
      <option value="vitesse-light">Vitesse Light</option>
    </select>
    <select id="language-dropdown" class="w-1/3 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="python" selected>Python</option>
      <option value="javascript">JavaScript</option>
      <option value="typescript">TypeScript</option>
      <option value="html">HTML</option>
      <option value="css">CSS</option>
      <option value="json">JSON</option>
      <option value="markdown">Markdown</option>
      <option value="java">Java</option>
      <option value="c">C</option>
      <option value="cpp">C++</option>
      <option value="csharp">C#</option>
      <option value="go">Go</option>
      <option value="rust">Rust</option>
      <option value="swift">Swift</option>
      <option value="php">PHP</option>
      <option value="ruby">Ruby</option>
      <option value="sql">SQL</option>
      <option value="shell">Shell</option>
      <option value="yaml">YAML</option>
      <option value="xml">XML</option>
    </select>
    <button id="apply-button" class="w-1/4 p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
      Apply
    </button>
  </div>
  <div id="code-container" class="flex-grow overflow-auto">
    <!-- Code will be inserted here -->
  </div>
</div>

<link id="shiki-theme" rel="stylesheet" />

<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/all.min.js"></script>

<style>
  /* Custom styles */
  #code-container > pre {
    margin: 0;
    padding: 20px;
    height: 100%;
  }
</style>

<script>
let currentLanguage = 'python';

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
  // Removed the lines that escape quotes
}

async function loadShiki() {
  await loadScript('https://cdn.jsdelivr.net/npm/shiki@0.14.1/dist/index.unpkg.iife.js');
  return window.shiki;
}

async function highlightCode(code, language = currentLanguage) {
  // Remove the language declaration line if it exists
  if (code.trim().startsWith('$')) {
    const firstLine = code.trim().split('\n')[0];
    const declaredLang = firstLine.substring(1).trim().toLowerCase();
    code = code.substring(code.indexOf('\n') + 1);
  }
  
  currentLanguage = language || currentLanguage;
  
  const shiki = await loadShiki();
  const highlighter = await shiki.getHighlighter({
    theme: document.getElementById('theme-dropdown').value,
    langs: [currentLanguage]
  });
  
  const highlightedCode = highlighter.codeToHtml(code, { lang: currentLanguage });
  
  const codeContainer = document.getElementById('code-container');
  codeContainer.innerHTML = `<pre><code>${highlightedCode}</code></pre>`;
  
  // Update the language dropdown
  document.getElementById('language-dropdown').value = currentLanguage;
}

async function changeTheme(theme) {
  const shiki = await loadShiki();
  const highlighter = await shiki.getHighlighter({
    theme: theme,
    langs: [currentLanguage]
  });
  
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const code = codeElement.textContent;
    const highlightedCode = highlighter.codeToHtml(code, { lang: currentLanguage });
    document.getElementById('code-container').innerHTML = highlightedCode;
    
    // Send message to plugin code to save the theme
    parent.postMessage({ pluginMessage: { type: 'themeChanged', theme } }, '*');
    
    // Remove the resizing code
  }
}

function changeLanguage(language) {
  currentLanguage = language;
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const code = codeElement.textContent;
    highlightCode(code, language);
  }
}

function applyColors() {
  const codeElement = document.querySelector('#code-container pre code pre');
  if (codeElement) {
    const colorData = [];
    const backgroundColor = window.getComputedStyle(codeElement).backgroundColor;
    const hasLanguageDeclaration = codeElement.textContent.trim().startsWith('$');
    
    // Recursively process all child nodes
    function processNode(node, isFirstLine) {
      if (node.nodeType === Node.TEXT_NODE) {
        const parentStyle = window.getComputedStyle(node.parentElement);
        if (!isFirstLine || !hasLanguageDeclaration) {
          colorData.push({
            text: node.textContent,
            color: parentStyle.color
          });
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        let isFirst = isFirstLine;
        for (let child of node.childNodes) {
          processNode(child, isFirst);
          isFirst = false;
        }
      }
    }
    
    processNode(codeElement, true);
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'applyDetailedColors', 
        colorData,
        backgroundColor,
        hasLanguageDeclaration
      } 
    }, '*');
  }
}

document.getElementById('theme-dropdown').addEventListener('change', (event) => {
  changeTheme(event.target.value);
});

document.getElementById('language-dropdown').addEventListener('change', (event) => {
  changeLanguage(event.target.value);
});

document.getElementById('apply-button').addEventListener('click', applyColors);

onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'code') {
    highlightCode(msg.content, msg.language);
  } else if (msg.type === 'no-selection') {
    document.getElementById('code-container').innerHTML = '<p style="color: #333; display: flex; justify-content: center; align-items: center; height: 100%;">ℹ️ Please select a single text layer</p>';
  } else if (msg.type === 'setTheme') {
    document.getElementById('theme-dropdown').value = msg.theme;
    changeTheme(msg.theme);
  }
}

async function initPlugin() {
  try {
    await loadShiki();
    
    // Set the default theme to Light Plus
    await changeTheme('light-plus');
    
    // Update the dropdowns to reflect the default values
    document.getElementById('theme-dropdown').value = 'light-plus';
    document.getElementById('language-dropdown').value = 'python';
    
    parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
  } catch (error) {
    console.error('Failed to load Shiki:', error);
  }
}

initPlugin();
</script>
