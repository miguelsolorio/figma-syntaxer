<div id="theme-selector">
  <select id="theme-dropdown">
    <option value="prism">Default</option>
    <option value="prism-vsc-dark-plus">VS Code Dark</option>
    <option value="prism-vs">VS Code Light</option>
    <option value="prism-coy">Coy</option>
    <option value="prism-dark">Dark</option>
    <option value="prism-funky">Funky</option>
    <option value="prism-okaidia">Okaidia</option>
    <option value="prism-solarizedlight">Solarized Light</option>
    <option value="prism-tomorrow">Tomorrow</option>
    <option value="prism-twilight">Twilight</option>
    <option value="prism-cb">CB</option>
    <option value="prism-ghcolors">GHColors</option>
    <option value="prism-pojoaque">Pojoaque</option>
    <option value="prism-xonokai">Xonokai</option>
    <option value="prism-ateliersulphurpool-light">Ateliersulphurpool-light</option>
    <option value="prism-hopscotch">Hopscotch</option>
    <option value="prism-atom-dark">Atom Dark</option>
    <option value="prism-duotone-dark">Duotone Dark</option>
    <option value="prism-duotone-sea">Duotone Sea</option>
    <option value="prism-duotone-space">Duotone Space</option>
    <option value="prism-duotone-earth">Duotone Earth</option>
    <option value="prism-duotone-forest">Duotone Forest</option>
    <option value="prism-duotone-light">Duotone Light</option>
    <option value="prism-vs">VS</option>
    <option value="prism-darcula">Darcula</option>
    <option value="prism-a11y-dark">a11y Dark</option>
    <option value="prism-dracula">Dracula</option>
    <option value="prism-synthwave84">Synthwave '84</option>
    <option value="prism-shades-of-purple">Shades of Purple</option>
    <option value="prism-material-dark">Material Dark</option>
    <option value="prism-material-light">Material Light</option>
    <option value="prism-material-oceanic">Material Oceanic</option>
    <option value="prism-nord">Nord</option>
    <option value="prism-coldark-cold">Coldark Cold</option>
    <option value="prism-coldark-dark">Coldark Dark</option>
    <option value="prism-coy-without-shadows">Coy without shadows</option>
    <option value="prism-gruvbox-dark">Gruvbox Dark</option>
    <option value="prism-gruvbox-light">Gruvbox Light</option>
    <option value="prism-lucario">Lucario</option>
    <option value="prism-night-owl">Night Owl</option>
    <option value="prism-holi-theme">Holi Theme</option>
    <option value="prism-z-touch">Z-Touch</option>
    <option value="prism-solarized-dark-atom">Solarized Dark Atom</option>
    <option value="prism-one-dark">One Dark</option>
    <option value="prism-one-light">One Light</option>
    <option value="prism-laserwave">Laserwave</option>
  </select>
  <button id="apply-button">Apply</button>
</div>
<div id="code-container"></div>

<link id="prism-theme" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
  }
  #code-container {
    white-space: pre-wrap;
  }
  #code-container pre {
    margin: 0;
    padding: 20px;
  }
  #theme-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #f0f0f0;
    border-bottom: 1px solid #ccc;
  }
  #theme-dropdown {
    width: 70%;
    padding: 5px;
  }
  #apply-button {
    width: 25%;
    padding: 5px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }
  #apply-button:hover {
    background-color: #45a049;
  }
</style>

<script>
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function highlightCode(code) {
  const escapedCode = escapeHtml(code);
  const codeContainer = document.getElementById('code-container');
  codeContainer.innerHTML = `<pre><code class="language-javascript">${escapedCode}</code></pre>`;
  if (typeof Prism !== 'undefined') {
    Prism.highlightAll();
    // After highlighting, calculate dimensions and resize
    const width = codeContainer.scrollWidth; // Add some padding
    const height = codeContainer.scrollHeight; // Add padding for header
    parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
  } else {
    console.error('Prism is not defined');
  }
}

function changeTheme(theme) {
  const linkElement = document.getElementById('prism-theme');
  if (theme === 'prism') {
    linkElement.href = 'https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css';
  } else {
    linkElement.href = `https://cdn.jsdelivr.net/npm/prism-themes@1.9.0/themes/${theme}.min.css`;
  }
  
  // Send message to plugin code to save the theme
  parent.postMessage({ pluginMessage: { type: 'themeChanged', theme } }, '*');
  
  // Re-highlight the code with the new theme
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement && typeof Prism !== 'undefined') {
    Prism.highlightElement(codeElement);
    
    // Recalculate dimensions and resize
    const codeContainer = document.getElementById('code-container');
    const width = codeContainer.scrollWidth;
    const height = codeContainer.scrollHeight;
    parent.postMessage({ pluginMessage: { type: 'resize', width, height } }, '*');
  }
}

function applyColors() {
  const codeElement = document.querySelector('#code-container pre code');
  if (codeElement) {
    const colorData = [];
    const backgroundColor = window.getComputedStyle(codeElement).backgroundColor;
    
    // Recursively process all child nodes
    function processNode(node) {
      if (node.nodeType === Node.TEXT_NODE) {
        const parentStyle = window.getComputedStyle(node.parentElement);
        colorData.push({
          text: node.textContent,
          color: parentStyle.color
        });
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        for (let child of node.childNodes) {
          processNode(child);
        }
      }
    }
    
    processNode(codeElement);
    
    parent.postMessage({ 
      pluginMessage: { 
        type: 'applyDetailedColors', 
        colorData,
        backgroundColor
      } 
    }, '*');
  }
}

document.getElementById('theme-dropdown').addEventListener('change', (event) => {
  changeTheme(event.target.value);
});

document.getElementById('apply-button').addEventListener('click', applyColors);

onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'code') {
    highlightCode(msg.content);
  } else if (msg.type === 'no-selection') {
    document.getElementById('code-container').innerHTML = '<p>Please select a single text layer</p>';
  } else if (msg.type === 'setTheme') {
    document.getElementById('theme-dropdown').value = msg.theme;
    changeTheme(msg.theme);
  }
}

async function initPlugin() {
  try {
    await loadScript('https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js');
    await loadScript('https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js');
    
    parent.postMessage({ pluginMessage: { type: 'init' } }, '*');
  } catch (error) {
    console.error('Failed to load Prism:', error);
  }
}

initPlugin();
</script>
